<?xml version="1.0"?>
<project name="peaberry" default="dist">

  <property file="build.properties"/>

  <import file="clover.xml"/>
  <import file="bnd.xml"/>
  <import file="test.xml"/>
  <import file="doc.xml"/>

  <taskdef resource="proguard/ant/task.properties" classpath="${proguard.jar}"/>

  <target name="guice" depends="check.guice,trim.guice"/>

  <target name="check.guice">
    <available file="${guice.jar}" property="have.guice"/>
  </target>

  <target name="trim.guice" unless="have.guice">
    <mkdir dir="${build}/dist"/>
    <proguard>
      -libraryjars "${java.home}/lib/rt.jar"
      -libraryjars ${lib}/aopalliance-${aop.version}.jar
      -injars ${lib}/guice-${guice.version}.jar
      -outjars ${guice.jar}
      -keep class !com.google.inject.internal.collect.** { *; }
      -keepattributes
      -dontobfuscate
      -dontoptimize
      -dontnote
    </proguard>
  </target>

  <target name="compile" depends="guice">
    <mkdir dir="${build}/classes"/>
    <javac debug="on" srcdir="${src}" destdir="${build}/classes" classpath="${build.cp}">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  <target name="test.compile" depends="compile">
    <mkdir dir="${build}/test-classes"/>
    <javac debug="on" srcdir="${test}" destdir="${build}/test-classes" classpath="${test.cp}">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  <target name="clean">
    <delete dir="${build}/classes"/>
    <delete dir="${build}/test-classes"/>
    <delete dir="${build}/test"/>
  </target>

  <target name="clean.all">
    <delete dir="${build}"/>
  </target>

  <target name="wipe" depends="clean.all"/>

  <target name="jar" depends="peaberry"/>

  <target name="dist" depends="peaberry,doc">
    <jar destfile="${build}/dist/peaberry-${version}-javadoc.jar" basedir="${doc}/javadoc"/>
    <jar destfile="${build}/dist/peaberry-${version}-sources.jar" basedir="${src}">
      <metainf dir="." includes="NOTICE,LICENSE"/>
    </jar>
    <copy todir="${build}/dist">
      <fileset dir="." includes="NOTICE,LICENSE*,README.TXT,pom.xml"/>
      <filtermapper>
        <replacestring from="pom.xml" to="peaberry-${version}.pom"/>
      </filtermapper>
      <filterset>
        <filter token="AOP_VERSION" value="${aop.version}"/>
        <filter token="GUICE_VERSION" value="${guice.version}"/>
        <filter token="VERSION" value="${version}"/>
      </filterset>
    </copy>
    <checksum format="MD5SUM" algorithm="md5">
      <fileset dir="${build}/dist" includes="*.jar,*.pom"/>
    </checksum>
    <zip destfile="${build}/peaberry-${version}.zip" basedir="${build}/dist"/>
    <checksum format="MD5SUM" algorithm="md5" file="${build}/peaberry-${version}.zip"/>
  </target>

  <target name="test.dist" depends="peaberry,test.peaberry"/>

  <target name="reports" depends="clean,with.clover,peaberry,test.peaberry,clover.report,pmd"/>

</project>
